AWSTemplateFormatVersion: "2010-09-09"
Description: "Platform Module - Database Migration Security Groups for Aurora Serverless and DMS"

Parameters:
  VPCId:
    Type: AWS::EC2::VPC::Id
    Description: Select the VPC from existing deployment

  RDSSourceSecurityGroupId:
    Type: AWS::EC2::SecurityGroup::Id
    Description: Select the existing RDS Security Group to update

  VPCEndpointSecurityGroupId:
    Type: AWS::EC2::SecurityGroup::Id
    Description: Select the VPC Endpoint Security Group from Platform Module

Resources:
  # ============================================================================
  # AURORA SERVERLESS SECURITY GROUP
  # ============================================================================

  AuroraServerlessSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Aurora Serverless database - allows only authorized database connections
      VpcId: !Ref VPCId
      Tags:
        - Key: Name
          Value: Platform-Aurora-Serverless-SG
        - Key: Module
          Value: Platform
        - Key: Purpose
          Value: Database

  # ============================================================================
  # DMS REPLICATION SECURITY GROUP
  # ============================================================================

  DMSReplicationSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for DMS replication instance - enables database migration traffic
      VpcId: !Ref VPCId
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          DestinationSecurityGroupId: !Ref RDSSourceSecurityGroupId
          Description: MySQL access to source RDS database for reading data
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          DestinationSecurityGroupId: !Ref AuroraServerlessSecurityGroup
          Description: MySQL access to target Aurora database for writing data
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          DestinationSecurityGroupId: !Ref VPCEndpointSecurityGroupId
          Description: HTTPS access to AWS services through VPC endpoints
      Tags:
        - Key: Name
          Value: Platform-DMS-Replication-SG
        - Key: Module
          Value: Platform
        - Key: Purpose
          Value: Migration

  # ============================================================================
  # UPDATE EXISTING RDS SECURITY GROUP
  # ============================================================================

  RDSSourceIngressRule:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref RDSSourceSecurityGroupId
      IpProtocol: tcp
      FromPort: 3306
      ToPort: 3306
      SourceSecurityGroupId: !Ref DMSReplicationSecurityGroup
      Description: MySQL access from DMS replication instance for source data reading

  AuroraDMSIngressRule:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref AuroraServerlessSecurityGroup
      IpProtocol: tcp
      FromPort: 3306
      ToPort: 3306
      SourceSecurityGroupId: !Ref DMSReplicationSecurityGroup
      Description: MySQL access from DMS replication instance for data migration

Outputs:
  # Aurora Serverless Security Group
  AuroraServerlessSecurityGroupId:
    Description: Aurora Serverless Security Group ID
    Value: !Ref AuroraServerlessSecurityGroup
    Export:
      Name: OrchardLite-Platform-Aurora-SG-ID

  # DMS Replication Security Group
  DMSReplicationSecurityGroupId:
    Description: DMS Replication Security Group ID
    Value: !Ref DMSReplicationSecurityGroup
    Export:
      Name: OrchardLite-Platform-DMS-SG-ID

  # Security Group ARNs for cross-stack references
  AuroraServerlessSecurityGroupArn:
    Description: Aurora Serverless Security Group ARN
    Value: !Sub "arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:security-group/${AuroraServerlessSecurityGroup}"
    Export:
      Name: OrchardLite-Platform-Aurora-SG-ARN

  DMSReplicationSecurityGroupArn:
    Description: DMS Replication Security Group ARN
    Value: !Sub "arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:security-group/${DMSReplicationSecurityGroup}"
    Export:
      Name: OrchardLite-Platform-DMS-SG-ARN
