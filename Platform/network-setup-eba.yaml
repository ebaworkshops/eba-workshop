AWSTemplateFormatVersion: "2010-09-09"
Description: "Platform Module - Network Security Infrastructure for OrchardLite CMS Modernization"

Parameters:
  VPCId:
    Type: AWS::EC2::VPC::Id
    Description: Select the VPC from existing deployment

  PublicSubnet1Id:
    Type: AWS::EC2::Subnet::Id
    Description: Select Public Subnet 1 (for NAT Gateway deployment)

  PublicSubnet2Id:
    Type: AWS::EC2::Subnet::Id
    Description: Select Public Subnet 2

Resources:
  # ============================================================================
  # PRIVATE SUBNETS
  # ============================================================================
  
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPCId
      CidrBlock: 10.0.3.0/24
      AvailabilityZone: !Select [0, !GetAZs ""]
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: OrchardLite-Platform-Private-1
        - Key: Module
          Value: Platform
        - Key: Type
          Value: Private

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPCId
      CidrBlock: 10.0.4.0/24
      AvailabilityZone: !Select [1, !GetAZs ""]
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: OrchardLite-Platform-Private-2
        - Key: Module
          Value: Platform
        - Key: Type
          Value: Private

  # ============================================================================
  # ROUTE TABLES FOR PRIVATE SUBNETS
  # ============================================================================

  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPCId
      Tags:
        - Key: Name
          Value: OrchardLite-Platform-Private-RT-1
        - Key: Module
          Value: Platform

  PrivateRouteTable2:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPCId
      Tags:
        - Key: Name
          Value: OrchardLite-Platform-Private-RT-2
        - Key: Module
          Value: Platform

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable1

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable2

  # ============================================================================
  # NAT GATEWAY
  # ============================================================================

  NATGatewayEIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: OrchardLite-Platform-NAT-EIP
        - Key: Module
          Value: Platform

  NATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NATGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet1Id
      Tags:
        - Key: Name
          Value: OrchardLite-Platform-NAT-Gateway
        - Key: Module
          Value: Platform

  # Routes to NAT Gateway for private subnets
  PrivateRoute1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGateway

  PrivateRoute2:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable2
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NATGateway

  # ============================================================================
  # SECURITY GROUPS
  # ============================================================================

  VPCEndpointSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for VPC Endpoints
      VpcId: !Ref VPCId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 10.0.3.0/24
          Description: HTTPS from Private Subnet 1
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 10.0.4.0/24
          Description: HTTPS from Private Subnet 2
      Tags:
        - Key: Name
          Value: Platform-VPCEndpoint-SG
        - Key: Module
          Value: Platform



  # ============================================================================
  # VPC ENDPOINTS
  # ============================================================================

  # S3 Gateway Endpoint
  S3VPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPCId
      ServiceName: !Sub com.amazonaws.${AWS::Region}.s3
      VpcEndpointType: Gateway
      RouteTableIds:
        - !Ref PrivateRouteTable1
        - !Ref PrivateRouteTable2

  # ECR Interface Endpoint
  ECRVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPCId
      ServiceName: !Sub com.amazonaws.${AWS::Region}.ecr.dkr
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
      PrivateDnsEnabled: true

  # CloudWatch Logs Interface Endpoint
  CloudWatchLogsVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPCId
      ServiceName: !Sub com.amazonaws.${AWS::Region}.logs
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
      PrivateDnsEnabled: true

  # RDS Interface Endpoint
  RDSVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPCId
      ServiceName: !Sub com.amazonaws.${AWS::Region}.rds
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
      PrivateDnsEnabled: true

  # Secrets Manager Interface Endpoint
  SecretsManagerVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPCId
      ServiceName: !Sub com.amazonaws.${AWS::Region}.secretsmanager
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
      PrivateDnsEnabled: true

  # KMS Interface Endpoint
  KMSVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPCId
      ServiceName: !Sub com.amazonaws.${AWS::Region}.kms
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
      PrivateDnsEnabled: true

  # Systems Manager Interface Endpoint
  SSMVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPCId
      ServiceName: !Sub com.amazonaws.${AWS::Region}.ssm
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
      PrivateDnsEnabled: true

Outputs:
  # Private Subnets
  PrivateSubnet1Id:
    Description: Private Subnet 1 ID
    Value: !Ref PrivateSubnet1
    Export:
      Name: OrchardLite-Platform-PrivateSubnet1-ID

  PrivateSubnet2Id:
    Description: Private Subnet 2 ID
    Value: !Ref PrivateSubnet2
    Export:
      Name: OrchardLite-Platform-PrivateSubnet2-ID

  # Route Tables
  PrivateRouteTable1Id:
    Description: Private Route Table 1 ID
    Value: !Ref PrivateRouteTable1
    Export:
      Name: OrchardLite-Platform-PrivateRouteTable1-ID

  PrivateRouteTable2Id:
    Description: Private Route Table 2 ID
    Value: !Ref PrivateRouteTable2
    Export:
      Name: OrchardLite-Platform-PrivateRouteTable2-ID

  # NAT Gateway
  NATGatewayId:
    Description: NAT Gateway ID
    Value: !Ref NATGateway
    Export:
      Name: OrchardLite-Platform-NATGateway-ID

  NATGatewayEIP:
    Description: NAT Gateway Elastic IP
    Value: !Ref NATGatewayEIP
    Export:
      Name: OrchardLite-Platform-NATGateway-EIP

  # Security Groups
  VPCEndpointSecurityGroupId:
    Description: VPC Endpoint Security Group ID
    Value: !Ref VPCEndpointSecurityGroup
    Export:
      Name: OrchardLite-Platform-VPCEndpoint-SG-ID

  # VPC Endpoints
  S3VPCEndpointId:
    Description: S3 VPC Endpoint ID
    Value: !Ref S3VPCEndpoint
    Export:
      Name: OrchardLite-Platform-S3VPCEndpoint-ID

  ECRVPCEndpointId:
    Description: ECR VPC Endpoint ID
    Value: !Ref ECRVPCEndpoint
    Export:
      Name: OrchardLite-Platform-ECRVPCEndpoint-ID

  CloudWatchLogsVPCEndpointId:
    Description: CloudWatch Logs VPC Endpoint ID
    Value: !Ref CloudWatchLogsVPCEndpoint
    Export:
      Name: OrchardLite-Platform-CloudWatchLogsVPCEndpoint-ID

  RDSVPCEndpointId:
    Description: RDS VPC Endpoint ID
    Value: !Ref RDSVPCEndpoint
    Export:
      Name: OrchardLite-Platform-RDSVPCEndpoint-ID

  SecretsManagerVPCEndpointId:
    Description: Secrets Manager VPC Endpoint ID
    Value: !Ref SecretsManagerVPCEndpoint
    Export:
      Name: OrchardLite-Platform-SecretsManagerVPCEndpoint-ID

  KMSVPCEndpointId:
    Description: KMS VPC Endpoint ID
    Value: !Ref KMSVPCEndpoint
    Export:
      Name: OrchardLite-Platform-KMSVPCEndpoint-ID

  SSMVPCEndpointId:
    Description: Systems Manager VPC Endpoint ID
    Value: !Ref SSMVPCEndpoint
    Export:
      Name: OrchardLite-Platform-SSMVPCEndpoint-ID